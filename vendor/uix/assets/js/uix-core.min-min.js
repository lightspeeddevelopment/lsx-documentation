var conduitApp={},coduitTemplates={},conduitRegisterApps,conduitModal,conduitModalSave,conduitGenID,conduitSaveObject,conduitGetData;jQuery(function($){var a=null;conduitException=function(a){this.message=a,this.name="ConduitException"},$.fn.conduitTrigger=function(a){var t={method:"GET",url:ajaxurl};return $.extend(!0,t,a),$.ajax(t).success(function(){}),this},$.fn.getObject=function(a){for(var t=$(this),e=t.find("[name]"),i={},n={},d=0;d<e.length;d++){var o=$(e[d]),c=o.prop("name").replace(/\]/gi,"").split("["),r=o.val(),p={};if((!a||!(c.indexOf("_id")>=0||c.indexOf("_node_point")>=0))&&(!o.is(":radio")&&!o.is(":checkbox")||o.is(":checked"))){if(o.prop("required")&&!o.val().length)throw o.focus(),new conduitException("requiredfield");for(var u=c.length-1;u>=0;u--){var l=c[u];if(void 0===l&&(l=""),0===l.length&&(p=[],void 0===n[c[u-1]]?n[c[u-1]]=0:n[c[u-1]]+=1,l=n[c[u-1]]),u===c.length-1){if(r)if("true"===r)r=!0;else if("false"===r)r=!1;else if(isNaN(parseFloat(r))||parseFloat(r).toString()!==r){if("string"==typeof r&&("{"===r.substr(0,1)||"["===r.substr(0,1)))try{r=JSON.parse(r)}catch(a){}}else r=parseFloat(r);p[l]=r}else{var s=p;p={},p[l]=s}}$.extend(!0,i,p)}}return i},conduitGeneralBaldrick=function(){$(".wp-trigger").conduitTrigger({method:"POST",before:function(a){var t=$(a),e=t.closest("[data-app]");e.length?t.data("data",JSON.stringify(conduitBuildData(e.data("app")))):t.data("data")&&t.data("data",JSON.stringify(conduitBuildData(t.data("data"))))}})},conduitSaveObject=function(t){var e;e=!0===t?conduitPrepObject():conduitPrepObject(t);var i={action:uix.slug+"_save_config",uix_setup:$("#uix_setup").val(),page_slug:uix.page_slug,config:JSON.stringify(e),autosave:!0};uix.save_params&&(i.params=uix.save_params),$(window).trigger("uix.saving"),a&&a.abort(),a=$.post(ajaxurl,i,function(t){$(window).trigger("uix.saved"),a=null})},conduitPrepObject=function(){var a={};for(var t in conduitApp)conduitApp[t].app&&(conduitApp[t].app.is(":visible")?a[t]=conduitBuildData(t):a[t]=conduitApp[t].data),a[t]._tab&&delete a[t]._tab;return a},conduitModalFooter=function(a){var t=a.buttons?a.buttons.split(" "):["save"],e=a.modal.split("."),i=a.app?a.app:a.trigger.closest("[data-app]").data("app"),n={__node_path:e.join(".")},d="",o;n.__app=i,a.trigger.data("before")&&(n.__before=a.trigger.data("before")),a.trigger.data("callback")&&(n.__callback=a.trigger.data("callback"));for(var c=0;c<t.length;c++)d+=$("#__partial_"+t[c]).length?$("#__partial_"+t[c]).html():"";return(o=Handlebars.compile(d,{data:!0}))(n)},conduitModal=function(a,t){var e=a.modal.split("."),i=a.app?a.app:a.trigger.closest("[data-app]").data("app"),n=a.default?a.default:null,d=Handlebars.compile('<div data-app="'+a.template+'">{{> '+a.template+"}}</div>",{data:!0});if(data={},conduitBuildData(i),conduitApp[i]){var o=conduitApp[i].data;if(null!==n)data=n;else{for(var c=0;c<e.length;c++)o=o[e[c]]?o[e[c]]:{};data=o}}return data.__node_path=a.points,data.__app=i,conduitApp[a.template]={app:t.content,data:data},coduitTemplates[a.template]=d,d(data)},conduitGetData=function(a){var t=a.trigger.data("app"),e={};return conduitApp[t]&&conduitApp[t].data?conduitApp[t].data:e},conduitBuildData=function(a){if(conduitApp[a]&&conduitApp[a].app)try{conduitApp[a].data=conduitApp[a].app.getObject()}catch(a){return!1}return conduitApp[a].data._tab&&delete conduitApp[a].data._tab,conduitApp[a].data},conduitSyncData=function(a){conduitBuildData(a)},conduitRegisterApps=function(){var a=$("[data-app]").not("._bound_app");if(a.length&&(a.each(function(){var a=$(this),t=a.data("app");conduitApp[t]={app:a,data:uix.config[t]?uix.config[t]:{}},a.addClass("_bound_app"),conduitBuildUI(t)}),uix.tabs))for(var t in uix.tabs)if(uix.tabs[t].default){$('[data-tab="'+t+'"]').trigger("click");break}},conduitBuildUI=function(a){if(conduitApp[a]){var t=conduitApp[a].data;t._tab={};for(var e in conduitApp)e!==a&&(t._tab[e]=conduitApp[e].data);conduitApp[a].app.html(coduitTemplates[a](t))}$(".uix-sortable").length&&$(".uix-sortable").each(function(){var a=$(this),t={forcePlaceholderSize:!0,placeholder:"uix-sortable-placeholder"};t=$.extend({},t,a.data()),$(this).sortable(t)}),$(window).trigger("uix.init"),$(window).trigger("modal.init")},conduitSetNode=function(a,t,e){for(var i=a.split("."),n='{ "'+i.join('": { "')+'" : '+JSON.stringify(e),d=0;d<i.length;d++)n+="}";var o=JSON.parse(n);$.extend(!0,conduitApp[t].data,o),conduitBuildUI(t)},conduitGenID=function(){var a=(new Date).getTime();return"ndxxxxxxxx".replace(/[xy]/g,function(t){var e=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==t?e:3&e|8).toString(16)})},conduitAddNode=function(a,t,e){var i=conduitGenID(),n={_id:i},d=a.data?a.data("addNode").split("."):a.split("."),o=e||a.data("nodeDefault"),c=d.join(".")+"."+i,r=JSON.parse('{ "_id" : "'+i+'", "_node_point" : "'+c+'" }');node_point_wrappers=$('[data-node-point="'+d.join(".")+'"]'),o&&"object"==typeof o&&$.extend(!0,r,o);for(var p='{ "'+d.join('": { "')+'" : { "'+i+'" : '+JSON.stringify(r),u=0;u<=d.length;u++)p+="}";var l=JSON.parse(p);conduitBuildData(t),$.extend(!0,conduitApp[t].data,l),node_point_wrappers.length&&node_point_wrappers.data("template")?node_point_wrappers.each(function(){var a=$(this),t=a.data("template");t&&coduitTemplates["__partial_"+t]&&a.append(coduitTemplates["__partial_"+t](r))}):conduitBuildUI(t)},$(document).on("keyup change",'[data-format="slug"]',function(a){var t=$(this);if(t.data("master")&&t.prop("required")&&this.value.length<=0&&"change"===a.type)return this.value=$(t.data("master")).val().replace(/[^a-z0-9]/gi,"_").toLowerCase(),void(this.value.length&&t.trigger("change"));this.value=this.value.replace(/[^a-z0-9]/gi,"_").toLowerCase()}),$(document).on("keyup change","[data-sync]",function(){var a=$(this);$(a.data("sync")).each(function(){var t=$(this);t.is("input")?t.val(a.val()).trigger("change"):t.text(a.val())})}),$(document).on("click","[data-add-node]",function(a){var t=$(this),e=t.closest("[data-app]").data("app");e&&"object"==typeof conduitApp[e]&&(a.preventDefault(),conduitAddNode(t,e))}),$(document).on("click","[data-remove-element]",function(a){var t=$(this),e=t.closest("[data-app]").data("app"),i=$(t.data("removeElement"));t.data("confirm")&&!confirm(t.data("confirm"))||(i.remove(),conduitSyncData(e))}),$(document).on("click","[data-save-object]",function(a){a.preventDefault();var t=$(this),e=$(this).data("saveObject"),i=$(".uix-save-spinner"),n=$(".save-confirm"),d=$(".uix-sub-nav"),o;o=!0===e?conduitPrepObject():conduitPrepObject(e),t.addClass("saving"),n.hide(),i.css({visibility:"visible",opacity:1,display:"inline-block"});var c={action:uix.slug+"_save_config",uix_setup:$("#uix_setup").val(),page_slug:uix.page_slug,config:JSON.stringify(o)};uix.save_params&&(c.params=uix.save_params),$.post(ajaxurl,c,function(a){i.css({visibility:"",opacity:0,display:"none"}),n.fadeIn(),setTimeout(function(){n.fadeOut(800)},2e3),t.removeClass("saving"),$(window).trigger("uix.saved")})}),$(document).on("change","[data-live-sync]",function(a){var t=$(this).closest("[data-app]").data("app");conduitSyncData(t)}),$(document).on("click","button[data-live-sync]",function(a){var t=$(this).closest("[data-app]").data("app");conduitSyncData(t)}),$(document).on("click",".uix-notice .notice-dismiss",function(){var a=$(this).closest(".uix-notice");a.slideUp(200,function(){a.remove()})}),$(document).on("click","[data-tab]",function(a){a.preventDefault();var t=$(this),e=t.data("tab"),i=$(".current[data-tab]").data("tab");if(i){if(conduitBuildData(i),i===e)return;$('[data-app="'+i+'"]').empty().hide()}$("[data-tab]").removeClass("current"),$('[data-app="'+e+'"]').show(),t.addClass("current"),conduitBuildUI(e)}),$("script[data-template]").each(function(){var a=$(this),t=a.data("template");coduitTemplates[t]=Handlebars.compile(a.html(),{data:!0})}),$("script[data-handlebars-partial]").each(function(){var a=$(this);Handlebars.registerPartial(a.data("handlebarsPartial"),a.html()),coduitTemplates["__partial_"+a.data("handlebarsPartial")]=Handlebars.compile(a.html(),{data:!0})}),$(document).on("click","[data-modal-node]",function(a){var t=$(this),e=t.data("modal-node").split("."),i=t.data("app")?t.data("app"):e.shift(),n=t.data("type")?t.data("type"):"save",d;if(t.data("before")&&("function"==typeof t.data("before")?t.data("before")(t):"function"==typeof window[t.data("before")]&&window[t.data("before")](t)),"delete"!==n)try{d=t.closest(".uix-modal-wrap").getObject()}catch(a){return}if("add"===n)conduitAddNode(e.join("."),i,d);else if("delete"===n){var o=e.shift();e.length&&(o+="["+e.join("][")+"]"),$('[name^="'+o+'"]').remove(),conduitBuildData(i),conduitBuildUI(i)}else conduitSetNode(e.join("."),i,d);$(window).trigger("close.modal"),t.data("callback")&&("function"==typeof t.data("callback")?t.data("callback")(d,t):"function"==typeof window[t.data("callback")]&&window[t.data("callback")](d,t))}),$(window).on("close.modal",function(a){var t=$(".current[data-tab]").data("tab");t&&conduitBuildUI(t)}),conduitRegisterApps(),window.onbeforeunload=function(){if(a)return!1}});